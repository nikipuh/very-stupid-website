<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoT Blitz Stats Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #2a3f5f;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #dropArea {
            border: 2px dashed #2a3f5f;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            transition: background-color 0.3s;
        }
        #dropArea:hover {
            background-color: #eaeaea;
        }
        #previewImage {
            max-width: 100%;
            margin-top: 20px;
            border-radius: 4px;
            display: none;
        }
        #resultContainer {
            display: none;
            margin-top: 20px;
        }
        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #resultsTable th, #resultsTable td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #resultsTable th {
            background-color: #2a3f5f;
            color: white;
        }
        #resultsTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #resultsTable tr:hover {
            background-color: #e6e6e6;
        }
        .good {
            color: #4CAF50;
            font-weight: bold;
        }
        .average {
            color: #FFC107;
            font-weight: bold;
        }
        .poor {
            color: #F44336;
            font-weight: bold;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a3f5f;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #errorMessage {
            color: #F44336;
            font-weight: bold;
            padding: 10px;
            display: none;
        }
        .btn {
            background-color: #2a3f5f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #1d2d40;
        }
        #loadingStatus {
            margin-left: 15px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>World of Tanks Blitz Stats Analyzer</h1>
        <p>Upload a battle loading screen screenshot to analyze player statistics.</p>
        
        <div id="dropArea">
            <h2>Drag & Drop Screenshot Here</h2>
            <p>Or click to select file</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>
        
        <div id="errorMessage"></div>
        
        <img id="previewImage" alt="Preview">
        
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span id="loadingStatus">Processing image...</span>
        </div>
    </div>
    
    <div id="resultContainer" class="container">
        <h2>Results</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Team</th>
                    <th>Tank</th>
                    <th>Wins</th>
                    <th>Losses</th>
                    <th>Battles</th>
                    <th>Win Rate</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>

    <script>
        const API_KEY = 'bd877d19a45983daba697ebbaf3cff22';
        const API_BASE = 'https://api.wotblitz.eu/wotb';
        
        // DOM elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('previewImage');
        const resultContainer = document.getElementById('resultContainer');
        const resultsBody = document.getElementById('resultsBody');
        const loading = document.getElementById('loading');
        const loadingStatus = document.getElementById('loadingStatus');
        const errorMessage = document.getElementById('errorMessage');
        
        // Event listeners
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', e => {
            e.preventDefault();
            dropArea.style.borderColor = '#4CAF50';
        });
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#2a3f5f';
        });
        dropArea.addEventListener('drop', e => {
            e.preventDefault();
            dropArea.style.borderColor = '#2a3f5f';
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFile(fileInput.files[0]);
            }
        });
        
        // Handle uploaded file
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = e => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                processImage(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // Process image with OCR
        async function processImage(imageUrl) {
            showLoading('Processing image with OCR...');
            hideError();
            resultsBody.innerHTML = '';
            resultContainer.style.display = 'none';
            
            try {
                const result = await Tesseract.recognize(imageUrl, 'eng', {
                    logger: message => {
                        if (message.status === 'recognizing text') {
                            loadingStatus.textContent = `OCR: ${Math.round(message.progress * 100)}%`;
                        }
                    }
                });
                
                const text = result.data.text;
                const players = extractPlayers(text);
                
                if (players.length === 0) {
                    showError('Could not detect any player names in the image. Please try a clearer screenshot.');
                    hideLoading();
                    return;
                }
                
                await fetchPlayerStats(players);
            } catch (error) {
                showError('Error processing image: ' + error.message);
                hideLoading();
            }
        }
        
        // Extract player names from OCR text
        function extractPlayers(text) {
            const players = [];
            const lines = text.split('\n');

            // Team identifiers
            const allies = ['VERBÜNDETE', 'ALLIES', 'СОЮЗНИКИ'];
            const enemies = ['GEGNER', 'ENEMIES', 'ПРОТИВНИКИ'];
            
            let currentTeam = '';
            
            for (const line of lines) {
                // Determine team
                if (allies.some(term => line.includes(term))) {
                    currentTeam = 'Allies';
                    continue;
                } else if (enemies.some(term => line.includes(term))) {
                    currentTeam = 'Enemies';
                    continue;
                }
                
                // Look for player entries - they typically have a clan tag pattern like [TAG]
                const playerRegex = /\[([A-Z0-9_-]{1,5})\]([A-Za-z0-9_.-]+)/g;
                const taglessPlayerRegex = /\b([A-Za-z0-9_]{3,16})\b/g;
                
                // First try to match players with clan tags
                let matches = [...line.matchAll(playerRegex)];
                
                if (matches.length > 0) {
                    for (const match of matches) {
                        // Extract tank name - usually follows the player name
                        const parts = line.split(match[0]);
                        let tank = parts[1] ? parts[1].trim() : 'Unknown';
                        
                        // Clean up tank name
                        tank = tank.replace(/^\s*\d+\s*/, '').trim(); // Remove leading numbers
                        
                        players.push({
                            name: match[2],
                            clan: match[1],
                            fullName: match[0],
                            team: currentTeam,
                            tank: tank
                        });
                    }
                } else if (currentTeam && !line.includes('Obj.') && !line.includes('T-')) { // Avoid tank names like Obj. 263
                    // Try to find standalone player names without clan tags
                    matches = [...line.matchAll(taglessPlayerRegex)];
                    
                    if (matches.length > 0) {
                        for (const match of matches) {
                            // Ignore common OCR errors and UI elements
                            const ignoredTerms = ['VERBUNDETE', 'GEGNER', 'ALLIES', 'ENEMIES', 'Heavy', 'Medium', 'Light', 'Tank', 'Destroyer'];
                            if (ignoredTerms.includes(match[0])) continue;
                            
                            // Extract tank name - usually follows the player name
                            const parts = line.split(match[0]);
                            let tank = parts[1] ? parts[1].trim() : 'Unknown';
                            
                            // Clean up tank name
                            tank = tank.replace(/^\s*\d+\s*/, '').trim(); // Remove leading numbers
                            
                            players.push({
                                name: match[0],
                                clan: '',
                                fullName: match[0],
                                team: currentTeam,
                                tank: tank
                            });
                        }
                    }
                }
            }
            
            // Look for specific tank names in the text and associate them with players
            const tankRegex = /(Obj\.\s+\d+|T\d+|IS-\d+|[A-Z]+-\d+|VK\s+\d+|WZ-\d+|Maus|Chieftain|Piranha|FV\d+)/g;
            const tankMatches = [...text.matchAll(tankRegex)];
            
            // If we found tank names, try to associate them with players
            if (tankMatches.length > 0) {
                for (let i = 0; i < Math.min(players.length, tankMatches.length); i++) {
                    if (players[i].tank === 'Unknown') {
                        players[i].tank = tankMatches[i][0];
                    }
                }
            }
            
            return players;
        }
        
        // Fetch player statistics
        async function fetchPlayerStats(players) {
            showLoading(`Fetching data for ${players.length} players...`);
            
            try {
                // Process players in batches to avoid too many concurrent requests
                const batchSize = 3;
                const playerResults = [];
                
                for (let i = 0; i < players.length; i += batchSize) {
                    const batch = players.slice(i, i + batchSize);
                    const batchPromises = batch.map(player => processPlayer(player));
                    
                    loadingStatus.textContent = `Fetching player data (${i+1}-${Math.min(i+batchSize, players.length)}/${players.length})...`;
                    
                    const results = await Promise.all(batchPromises);
                    playerResults.push(...results);
                }
                
                // Display results
                displayResults(playerResults);
                hideLoading();
                resultContainer.style.display = 'block';
                
            } catch (error) {
                showError('Error fetching player stats: ' + error.message);
                hideLoading();
            }
        }
        
        // Process a single player
        async function processPlayer(player) {
            try {
                // Step 1: Find account ID
                const searchUrl = `${API_BASE}/account/list/?application_id=${API_KEY}&search=${encodeURIComponent(player.name)}&limit=1&type=exact&fields=account_id`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                if (searchData.status !== 'ok' || !searchData.data || searchData.data.length === 0) {
                    return {
                        ...player,
                        wins: 'N/A',
                        losses: 'N/A',
                        battles: 'N/A',
                        winRate: 'N/A'
                    };
                }
                
                const accountId = searchData.data[0].account_id;
                
                // Step 2: Get player stats
                const statsUrl = `${API_BASE}/account/info/?application_id=${API_KEY}&account_id=${accountId}&fields=statistics.all.wins,statistics.all.losses,statistics.all.battles`;
                const statsResponse = await fetch(statsUrl);
                const statsData = await statsResponse.json();
                
                if (statsData.status !== 'ok' || !statsData.data || !statsData.data[accountId]) {
                    return {
                        ...player,
                        wins: 'N/A',
                        losses: 'N/A',
                        battles: 'N/A',
                        winRate: 'N/A'
                    };
                }
                
                const stats = statsData.data[accountId].statistics.all;
                const wins = stats.wins || 0;
                const losses = stats.losses || 0;
                const battles = stats.battles || 0;
                const winRate = battles > 0 ? ((wins / battles) * 100).toFixed(2) : 'N/A';
                
                return {
                    ...player,
                    wins,
                    losses,
                    battles,
                    winRate
                };
                
            } catch (error) {
                console.error(`Error processing player ${player.name}:`, error);
                return {
                    ...player,
                    wins: 'Error',
                    losses: 'Error',
                    battles: 'Error',
                    winRate: 'Error'
                };
            }
        }
        
        // Display results in the table
        function displayResults(players) {
            resultsBody.innerHTML = '';
            
            for (const player of players) {
                const row = document.createElement('tr');
                
                // Determine win rate color class
                let winRateClass = '';
                if (player.winRate !== 'N/A' && player.winRate !== 'Error') {
                    const wr = parseFloat(player.winRate);
                    if (wr >= 55) winRateClass = 'good';
                    else if (wr >= 48) winRateClass = 'average';
                    else winRateClass = 'poor';
                }
                
                row.innerHTML = `
                    <td>${player.clan ? `[${player.clan}]${player.name}` : player.name}</td>
                    <td>${player.team || 'Unknown'}</td>
                    <td>${player.tank || 'Unknown'}</td>
                    <td>${player.wins}</td>
                    <td>${player.losses}</td>
                    <td>${player.battles}</td>
                    <td class="${winRateClass}">${player.winRate}${player.winRate !== 'N/A' && player.winRate !== 'Error' ? '%' : ''}</td>
                `;
                
                resultsBody.appendChild(row);
            }
        }
        
        // Helper functions for UI states
        function showLoading(message) {
            loading.style.display = 'flex';
            loadingStatus.textContent = message;
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
    </script>
</body>
</html>
